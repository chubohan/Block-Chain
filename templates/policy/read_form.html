<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>æ¸¬è©¦æ¨£æ¿</title>
<!-- é€£çµæ€æºä¸­æ–‡åŠcss -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script><!--è¨˜å¾—å®¶é€™è¡Œ-->
<link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC" rel="stylesheet">
<link href="/static/imgs/icon.jpg" rel="shortcut icon">
<link href="/static/css/menu.css" rel="stylesheet"/>  
<link href="/static/css/main.css" rel="stylesheet"/>      
<!------------------------->
</head>
   
<body>
    <!--**************************-->
    <div class="container">    
        <!--~~~~~~~~~~~~~~~~~-->
        <div class="header">           
        </div>        
        
        <!--~~~~~~~~~~~~~~~~~-->        
        <ul id="navigation">        
            <li><a href="/">è¿”å›ä¸»é </a></li> 
        </ul>
        
        <!--~~~~~~~~~~~~~~~~~--> 
        <div class="content">
            
            <h1>ç”µå­ä¿å•æŸ¥è¯¢ç³»ç»Ÿ</h1>
    
            <div>
                <input type="text" id="policyNumber" placeholder="è¯·è¾“å…¥ä¿å•å·ç ">
                <button id="connectBtn">è¿æ¥é’±åŒ…</button>
                <button id="queryBtn">æŸ¥è¯¢ä¿å•</button>
            </div>
            <div class="wallet-status">
                <span id="walletAddress">æœªè¿æ¥é’±åŒ…</span>
            </div>
            <div id="loading" class="loading" style="display: none;">æŸ¥è¯¢ä¸­...</div>
            <div id="result"></div>
        
            <!-- æˆæƒç®¡ç†ç•Œé¢ -->
        <div id="authTab" class="tab-content">
            <h2>ä¿å•æˆæƒç®¡ç†</h2>
            
            <div class="auth-form">
                <div class="form-group">
                    <label>ä¿å•å·ç ï¼š</label>
                    <input type="text" id="authPolicyNumber" placeholder="POL-001">
                </div>
                
                <div class="form-group">
                    <label>æˆæƒåœ°å€ï¼š</label>
                    <input type="text" id="authAddress" placeholder="0x...">
                </div>
                
                <div class="button-group">
                    <button onclick="grantAuthorization()">æˆäºˆæƒé™</button>
                    <button onclick="revokeAuthorization()">æ’¤é”€æƒé™</button>
                </div>
            </div>
            
            <div id="authStatus"></div>

            
        </div>
        
        <!--~~~~~~~~~~~~~~~~~--> 
        <div class="footer">
            NTUB imd, 2023.
        </div>  
    </div>
    <!--**************************-->    
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; // æ›¿æ¢ä¸ºå®é™…åˆçº¦åœ°å€
        const contractABI = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_policyNumber",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_policyHolder",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_insuredPerson",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_insuranceAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_premiumPeriod",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_premiumAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_startDate",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "_beneficiary",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_growthRate",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_declaredInterestRate",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "_pdfHash",
				"type": "string"
			}
		],
		"name": "addPolicy",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_policyNumber",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "_wallet",
				"type": "address"
			}
		],
		"name": "authorizePolicyAccess",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_policyNumber",
				"type": "string"
			}
		],
		"name": "deletePolicy",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_policyNumber",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "_wallet",
				"type": "address"
			}
		],
		"name": "revokePolicyAccess",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_policyNumber",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_policyHolder",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_insuredPerson",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_beneficiary",
				"type": "string"
			}
		],
		"name": "updatePolicy",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_policyNumber",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_pdfHash",
				"type": "string"
			}
		],
		"name": "updatePolicyPDF",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_policyNumber",
				"type": "string"
			}
		],
		"name": "getPolicy",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getPolicyCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_policyNumber",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "_wallet",
				"type": "address"
			}
		],
		"name": "isAuthorized",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "policies",
		"outputs": [
			{
				"internalType": "string",
				"name": "policyNumber",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "policyHolder",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "insuredPerson",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "insuranceAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "premiumPeriod",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "premiumAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "startDate",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "beneficiary",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "growthRate",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "declaredInterestRate",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "pdfHash",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "policyNumbers",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]; // ä¿æŒä¸ä¹‹å‰æä¾›çš„ABIä¸€è‡´

    let insuranceContract = null;

        // è¿æ¥é’±åŒ…å‡½æ•°ï¼ˆæ”¹é€ åï¼‰
async function connectWallet() {
    try {
        if (!window.ethereum) throw new Error("è¯·å®‰è£…MetaMask");
        
        // åˆå§‹åŒ–Provider
        const provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        
        // è·å–Signer
        const signer = await provider.getSigner();
        // åˆå§‹åŒ–åˆçº¦å®ä¾‹
        insuranceContract = new ethers.Contract(
            "0x5FbDB2315678afecb367f032d93F642f64180aa3", // æ›¿æ¢å®é™…åœ°å€
            contractABI,
            signer
        );
        
// éªŒè¯åˆçº¦è¿æ¥
console.log("åˆçº¦å®ä¾‹:", insuranceContract);
        console.log("åˆçº¦åœ°å€:", await insuranceContract.getAddress());
        // æ›´æ–°é’±åŒ…çŠ¶æ€
        const address = await signer.getAddress();
        document.getElementById("walletAddress").textContent = 
            `ä½ çš„éŒ¢åŒ…:${address.slice(0,6)}...${address.slice(-4)}`;
    }
     catch (error) {
        console.error("è¿æ¥é”™è¯¯:", error);
        alert(`è¿æ¥å¤±è´¥: ${error.message}`);
     }
}
// UIçŠ¶æ€æ›´æ–°å‡½æ•°
function updateUI() {
    const btn = document.getElementById('connectBtn');
    if (walletState.isConnected) {
        btn.innerHTML = "âœ”ï¸ å·²è¿æ¥";
        btn.style.backgroundColor = "#4CAF50";
    } else {
        btn.innerHTML = "ğŸ”— è¿æ¥é’±åŒ…";
        btn.style.backgroundColor = "#f44336";
    }
}
// ========== åŠ å¯†è§£å¯†é…ç½® ==========
const ENCRYPTION_CONFIG = {
    key: CryptoJS.enc.Utf8.parse("32-ByteSecretKey-123456789012"), // å¿…é¡»ä¸åŠ å¯†æ—¶ä¸€è‡´
    iv: CryptoJS.enc.Utf8.parse("16-ByteInitVector"), // å¿…é¡»ä¸åŠ å¯†æ—¶ä¸€è‡´
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.Pkcs7
};

// è§£å¯†å‡½æ•°ï¼ˆå®‰å…¨å¢å¼ºç‰ˆï¼‰
function decryptField(cipherText) {
    if (!cipherText || typeof cipherText !== 'string') {
        console.warn("æ— æ•ˆçš„å¯†æ–‡è¾“å…¥");
        return "N/A";
    }
    
    try {
        // éªŒè¯æ˜¯å¦ä¸ºåˆæ³•Base64æ ¼å¼
        if (!/^[A-Za-z0-9+/=]+$/.test(cipherText)) {
            throw new Error("å¯†æ–‡æ ¼å¼æ— æ•ˆ");
        }

        const bytes = CryptoJS.AES.decrypt(
            cipherText,
            ENCRYPTION_CONFIG.key,
            { 
                iv: ENCRYPTION_CONFIG.iv,
                mode: ENCRYPTION_CONFIG.mode,
                padding: ENCRYPTION_CONFIG.padding
            }
        );
        
        const decrypted = bytes.toString(CryptoJS.enc.Utf8);
        
        // éªŒè¯è§£å¯†ç»“æœ
        if (!decrypted) {
            throw new Error("è§£å¯†ç»“æœä¸ºç©º");
        }
        
        return decrypted;
    } catch (error) {
        console.error(`è§£å¯†å¤±è´¥ (${cipherText.slice(0,10)}...):`, error);
        return "âš ï¸ è§£å¯†é”™è¯¯";
    }
}

        // æŸ¥è¯¢ä¿å•
        async function queryPolicy() {
            const policyNumber = document.getElementById("policyNumber").value;
            const resultDiv = document.getElementById("result");
            const loading = document.getElementById("loading");
            
            try {
                if (!policyNumber) throw new Error("è¯·è¾“å…¥ä¿å•å·ç ");
                

                loading.style.display = "block";
                resultDiv.innerHTML = "";

                 // === æ ¸å¿ƒæƒé™éªŒè¯å¼€å§‹ ===
        // å¹¶è¡Œè·å–å¿…è¦æ•°æ®æå‡æ€§èƒ½
        const [currentAddress, policyInfo, isAuthorized] = await Promise.all([
            insuranceContract.runner.address,  // è·å–å½“å‰è¿æ¥åœ°å€
            insuranceContract.policies(policyNumber), // è·å–ä¿å•åŸºæœ¬ä¿¡æ¯
            insuranceContract.isAuthorized(policyNumber, await insuranceContract.runner.address) // æ£€æŸ¥æˆæƒçŠ¶æ€
        ]);

        // è§£æä¿å•æ‰€æœ‰è€…åœ°å€ï¼ˆæ ¹æ®ABIç»“æ„ï¼Œowneråœ¨ç¬¬10ä½ï¼‰
        const policyOwner = policyInfo[10]; 

        // æƒé™éªŒè¯é€»è¾‘
        const isOwner = currentAddress.toLowerCase() === policyOwner.toLowerCase();
        if (!isOwner && !isAuthorized) {
            throw new Error("âš ï¸ æ— è®¿é—®æƒé™ï¼šæ‚¨ä¸æ˜¯ä¿å•æ‰€æœ‰è€…ä¸”æœªè¢«æˆæƒæŸ¥çœ‹æ­¤ä¿å•");
        }
        // === æ ¸å¿ƒæƒé™éªŒè¯ç»“æŸ ===
    


                // è·å–ä¿å•æ•°æ®
                const policyData = await insuranceContract.getPolicy(policyNumber);
        console.log("åŸå§‹ä¿å•æ•°æ®:", policyData);
                
                // æ•°å€¼æ ¼å¼åŒ–å·¥å…·å‡½æ•°
const formatters = {
  weiToEth: (wei) => ethers.formatEther(wei),
  timestampToDate: (timestamp) => {
    if (!timestamp) return 'æœªè®¾ç½®';
    try {
      return new Date(Number(timestamp) * 1000).toLocaleDateString();
    } catch {
      return 'æ— æ•ˆæ—¥æœŸ';
    }
  },
  bigIntToString: (value) => value.toString(),
  parsePolicyData: (rawData) => ({
    
    policyHolder: rawData[0],
    insuredPerson: rawData[1],
    insuranceAmount: rawData[2],
    premiumPeriod: Number(rawData[3]),
    premiumAmount: rawData[4],
    startDate: formatters.timestampToDate(rawData[5]),
    beneficiary: rawData[6],
    growthRate: Number(rawData[7]),
    declaredInterestRate: Number(rawData[8]),
    pdfHash: rawData[9]
    
  })
};

               // è·å–å¹¶æ ¼å¼åŒ–æ•°æ®
    const rawData = await insuranceContract.getPolicy(policyNumber);
    const formattedData = formatters.parsePolicyData(rawData);
// æ¸²æŸ“æ•°æ®
renderPolicy(formattedData);     
            } catch (error) {
                loading.style.display = "none";
                showError(`æŸ¥è¯¢å¤±è´¥: ${error.message}`);
            }
        }
        function renderPolicy(data) {
  const html = `
    <div class="policy-info">
      
      <p>æŠ•ä¿äºº: ${data.policyHolder}</p>
      <p>è¢«ä¿äºº: ${data.insuredPerson}</p>
      <p>ä¿é¢: ${data.insuranceAmount} </p>
      <p>ç¼´è´¹å¹´é™: ${data.premiumPeriod} å¹´</p>
      <p>æ¯æœŸä¿è´¹: ${data.premiumAmount} </p>
      <p>ç”Ÿæ•ˆæ—¥æœŸ: ${data.startDate}</p>
      <p>å—ç›Šäºº: ${data.beneficiary}</p>
      <p>å¢é¢æ¯”ä¾‹: ${data.growthRate}%</p>
      <p>å®£å‘Šåˆ©ç‡: ${data.declaredInterestRate}%</p>
      <p>ä¿å•æ–‡ä»¶: <a href="https://ipfs.io/ipfs/${data.pdfHash}" target="_blank">æŸ¥çœ‹PDF</a></p>
    </div>
  `;
  document.getElementById("result").innerHTML = html;
}
        function showError(msg) {
            document.getElementById("result").innerHTML = `
                <div class="error">
                    âš ï¸ ${msg}
                    ${msg.includes("æƒé™") ? '<button onclick="connectWallet()">é‡æ–°è¿æ¥é’±åŒ…</button>' : ''}
                </div>
            `;
        }

        // äº‹ä»¶ç»‘å®š
        document.getElementById("connectBtn").addEventListener("click", connectWallet);
        document.getElementById("queryBtn").addEventListener("click", queryPolicy);
		
		
		
		/*ä»¥ä¸‹æ˜¯æˆæ¬Š--------------------------------------------------------------------------*/
		// åˆ‡æ¢é€‰é¡¹å¡
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(`${tabName}Tab`).classList.add('active');
    document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
}

// æˆäºˆæƒé™
async function grantAuthorization() {
    try {
        const policyNumber = document.getElementById('authPolicyNumber').value;
        const address = document.getElementById('authAddress').value;
        
        // éªŒè¯è¾“å…¥
        if (!policyNumber || !address) {
            throw new Error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
        }
        if (!ethers.isAddress(address)) {
            throw new Error("è¯·è¾“å…¥æœ‰æ•ˆçš„é’±åŒ…åœ°å€");
        }

        // éªŒè¯è°ƒç”¨è€…æƒé™
        const policyOwner = await insuranceContract.policies(policyNumber).then(r => r[10]);
        const currentAddress = await insuranceContract.runner.address;
        
        if (currentAddress.toLowerCase() !== policyOwner.toLowerCase()) {
            throw new Error("åªæœ‰ä¿å•æ‰€æœ‰è€…å¯ä»¥æˆæƒ");
        }

        // å‘é€æˆæƒäº¤æ˜“
        showAuthStatus("â³ æ­£åœ¨æäº¤æˆæƒäº¤æ˜“...", "processing");
        const tx = await insuranceContract.authorizePolicyAccess(policyNumber, address);
        await tx.wait();
        
        showAuthStatus("âœ… æˆæƒæˆåŠŸï¼", "success");
    } catch (error) {
        console.error("æˆæƒå¤±è´¥:", error);
        showAuthStatus(`âŒ é”™è¯¯: ${error.message}`, "error");
    }
}

// æ’¤é”€æƒé™
async function revokeAuthorization() {
    try {
        const policyNumber = document.getElementById('authPolicyNumber').value;
        const address = document.getElementById('authAddress').value;
        
        // è¾“å…¥éªŒè¯
        if (!policyNumber || !address) {
            throw new Error("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
        }
        if (!ethers.isAddress(address)) {
            throw new Error("æ— æ•ˆçš„é’±åŒ…åœ°å€æ ¼å¼");
        }
        
        showAuthStatus("â³ æ­£åœ¨æäº¤æ’¤é”€äº¤æ˜“...", "processing");
        const tx = await insuranceContract.revokePolicyAccess(policyNumber, address);
        await tx.wait();
        
        showAuthStatus("âœ… æƒé™æ’¤é”€æˆåŠŸï¼", "success");
    } catch (error) {
        console.error("æ’¤é”€æƒé™å¤±è´¥:", error);
        // å‹å¥½é”™è¯¯æç¤º
        let errorMsg = error.message;
        if (error.info?.error?.message.includes("caller is not the owner")) {
            errorMsg = "æ“ä½œè¢«æ‹’ç»ï¼šæ‚¨ä¸æ˜¯è¯¥ä¿å•çš„æ‰€æœ‰è€…";
        }
        showAuthStatus(`âŒ é”™è¯¯: ${error.message}`, "error");
    }
}

// çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
function showAuthStatus(message, type) {
    const statusDiv = document.getElementById('authStatus');
    statusDiv.innerHTML = message;
    statusDiv.className = `auth-status ${type}`;
    
    // è‡ªåŠ¨æ¸…é™¤çŠ¶æ€
    if (type !== 'processing') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
            statusDiv.className = 'auth-status';
        }, 5000);
    }
}
    </script>   
   <!--**************************-->       
</body>
   
</html>
